<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/sample.css">
    <title>ãƒ­ãƒ¼ã‚«ãƒ«SNS</title>

    <style>
        #output li {
            background: rgb(169, 201, 234);
            width: 800px;
            margin: 10px auto;
            border-radius: 10px;

        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
</head>

<body>

    <header>
        <h1>åœ°åŸŸå°‚ç”¨SNS</h1>
        <p class="headerp">è¶…ãƒ­ãƒ¼ã‚«ãƒ«ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ã</p>

    </header>

    <main>

        <div class="tab_area">
            <ul class="menu">
                <li id="tab" class="tab">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œã‚‹</li>
                <li id="tab" class="tab">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã«å…¥ã‚‹</li>
            </ul>
        </div>

        <div id="create" class="content">
            <dl>
                <dt>ã©ã®ã‚¨ãƒªã‚¢ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œã‚Šã¾ã™ã‹ï¼Ÿ <br>ï¼ˆä¾‹ï¼šã€‡ã€‡å…¬åœ’å‘¨è¾ºã€ã€‡ã€‡é«˜æ ¡å‘¨è¾ºï¼‰</dt>
                <dd>
                    <input type="text" id="comuname">
                </dd>
            </dl>

            <dl>
                <dt>ãã®ã‚¨ãƒªã‚¢ã«ã„ã‚‹äººã—ã‹åˆ†ã‹ã‚‰ãªã„ã€<br>ã€ç§˜å¯†ã®è³ªå•ã€ã‚’ä½œã‚Šã¾ã—ã‚‡ã†</dt>
                <dd>
                    <input type="text" id="question">
                </dd>
            </dl>

            <dl>
                <dt>ã€Œç§˜å¯†ã®è³ªå•ã€ã®ç­”ãˆã¯ï¼Ÿï¼ˆï¼ç§˜å¯†ã®åˆè¨€è‘‰ï¼‰</dt>
                <dd>
                    <input type="text" id="answer">
                </dd>

            </dl>

            <div>
                <ul class="menu">
                    <li id="send" class="tab">ä½œæˆ</li>
                    <li id="rewrite" class="tab">ä¿®æ­£</li>
                </ul>
            </div>
        </div>




        <div id="join" class="content">


            <div id="sendinfo2">
                <p id="comunityname"></p>
                <p id="scretquestion"></p>
                <dl class="pxchange">
                    <dt class="pxchange">ãŠåå‰</dt>
                    <dd>
                        <input type="text" id="yourname">
                    </dd>
                </dl>
                <dl>
                    <dt class="pxchange">ç§˜å¯†ã®è³ªå•ã¸ã®ç­”ãˆ(ã‚ãªãŸã®åˆè¨€è‘‰)</dt>
                    <dd>
                        <input type="text" id="yourword">
                    </dd>
                </dl>
                <dl>
                    <dt class="pxchange">
                        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                    </dt>
                    <dd>
                        <input id="mail" type="mailAddress">
                    </dd>
                </dl>
                <dl>
                    <dt class="pxchange">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰
                    </dt>
                    <dd>
                        <input id="password" type="password">
                    </dd>
                </dl>
                <div>
                    <button type="button" id="loginbutton">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    <button type="button" id="register">ç™»éŒ²</button>
                </div>

            </div>


            <div id="tweet_area" class="tweet_area">
                <div>
                    <p id="comunityname2"></p>
                    <p id="scretansewr">ã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã®åˆè¨€è‘‰</p>
                </div>

                <form>
                    <fieldset>
                        <legend>ã¤ã¶ã‚„ã</legend>
                        <div>
                            ãŠåå‰ï¼š <span id="tweetname"></span>
                        </div>
                        <div>
                            ã‚ãªãŸã®åˆè¨€è‘‰ï¼š<span id="tweetsecret"></span>
                        </div>
                        <div>
                            <button type="button" id="fastlogin" class="fastlogin">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°</button>
                        </div>
                        <div>
                            <textarea name="" id="tweettext" cols="30" rows="10"></textarea>
                        </div>
                        <div>
                            <button type="button" id="tweet">ã¤ã¶ã‚„ã</button>
                        </div>
                    </fieldset>
                </form>

                <ul id="output">

                </ul>
            </div>

        </div>

        <footer>Â©ãŸã‹ã¯ã—</footer>

    </main>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ //

        $(function () {
            let tabs = $(".tab"); // tabã®ã‚¯ãƒ©ã‚¹ã‚’å…¨ã¦å–å¾—ã—ã€å¤‰æ•°tabsã«é…åˆ—ã§å®šç¾©
            $(".tab").on("click", function () { // tabã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
                $(".active").removeClass("active"); // activeã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã™
                $(this).addClass("active"); // ã‚¯ãƒªãƒƒã‚¯ã—ãŸç®‡æ‰€ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                const index = tabs.index(this); // ã‚¯ãƒªãƒƒã‚¯ã—ãŸç®‡æ‰€ãŒã‚¿ãƒ–ã®ä½•ç•ªç›®ã‹åˆ¤å®šã—ã€å®šæ•°indexã¨ã—ã¦å®šç¾©
                $(".content").removeClass("show").eq(index).addClass("show"); // showã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã—ã¦ã€contentã‚¯ãƒ©ã‚¹ã®indexç•ªç›®ã«showã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            });
        });





        /*
                $("#sendinfo").on("click", function () {
                    $("#tweet_area").css("display", "inline");
        
                    const yourword = document.getElementById("yourword").value;
                    const yourname = document.getElementById("yourname").value;
                    console.log(yourword);
        
                    document.getElementById("tweetname").textContent = yourname;
                    document.getElementById("tweetsecret").textContent = yourword;
        
                    $("#sendinfo2").css("display", "none");
        
                });
                */


        // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•°
        function convertTimestampToDatetime(timestamp) {
            const _d = timestamp ? new Date(timestamp * 1000) : new Date();
            const Y = _d.getFullYear();
            const m = (_d.getMonth() + 1).toString().padStart(2, '0');
            const d = _d.getDate().toString().padStart(2, '0');
            const H = _d.getHours().toString().padStart(2, '0');
            const i = _d.getMinutes().toString().padStart(2, '0');
            const s = _d.getSeconds().toString().padStart(2, '0');
            return `${Y}/${m}/${d} ${H}:${i}:${s}`;
        }



    </script>

    <!-- ä»¥ä¸‹firebaseã®ã‚³ãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘ -->

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.7.0/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/9.7.0/firebase-auth.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // ğŸ”½ `onSnapshot`ã‚’è¿½è¨˜ğŸ”½*/
        // ğŸ”½ `query`ã¨`orderBy,setDoc,doc`ã‚’è¿½è¨˜*/
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            serverTimestamp,
            query,
            orderBy,
            onSnapshot,
        } from "https://www.gstatic.com/firebasejs/9.7.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "",
            authDomain: "localsns-10c26.firebaseapp.com",
            projectId: "localsns-10c26",
            storageBucket: "localsns-10c26.appspot.com",
            messagingSenderId: "86474711608",
            appId: "1:86474711608:web:ee1150ca3e52786bc93ccd"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /*ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ*/
        function loginsend() {

            let email = document.getElementById('mail').value;
            let password = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in

                    const uid = userCredential.user.uid;
                    console.log(uid);
                    alert("ç™»éŒ²ã—ã¾ã—ãŸ!");
                    // ...
                    const update = {
                        displayname: document.getElementById('yourname').value,
                        displaword: document.getElementById('yourword').value,
                    }

                    console.log(update);

                    setDoc(doc(db, "uerss", uid), update);

                    /*ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†
                    const q = query(collection(db, "uerss"));

                    onSnapshot(q, (querySnapshot) => {

                        /*ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ä¿å­˜ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ãŸã„å ´åˆã¯å¿…ãš{}å†…ã«å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹*/
                    /*querySnapshotã«å…¨éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹
                    console.log(querySnapshot.docs);

                    /*ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯ä½¿ã„ã«ãã„ã®ã§ã€ã»ã—ã„ã‚‚ã®ã ã‘ã‚’å–ã‚Šå‡ºã—ã¦documentsã«å…¥ã‚Œã‚‹*/

                    /*ğŸ”½ â†“ä»¥ä¸‹ã®å‡¦ç†ã¯æ¯å›ã€åŒã˜ã§ã‚¤ã‚±ã‚‹ã®ã§ä½¿ã„ã¾ã‚ã—ã¦OKDğŸ”½ 
                    const documentinfo = [];

                    querySnapshot.docs.forEach(function (doc) {
                        const data = {
                            id: doc.id,
                            data: doc.data(),
                        };
                        documentinfo.push(data);
                    });

                    console.log(documentinfo);

                    const uid = user.uid;
                    documentinfo.forEach(function (document) {

                        if (document.id === uid) {
                            console.log(document.data.displayname);
                            tweetname.innerHTML = `${document.data.displayname}`;
                            tweetsecret.innerHTML = `ã€${document.data.displaword}ã€`;
                        };


                    }); 

                }); */
                    $("#tweet_area").css("display", "inline");
                    $("#sendinfo2").css("display", "none");
                })
                .catch((error) => {
                    $("#tweet_area").css("display", "none");
                    $("#sendinfo2").css("display", "inline");
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert("ç™»éŒ²ã§ãã¾ã›ã‚“");


                    // ..
                });
        }



        /*ãƒ­ã‚°ã‚¤ãƒ³*/

        function login() {
            let email = document.getElementById('mail').value;
            let password = document.getElementById('password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    console.log(user);
                    // ...
                    $("#tweet_area").css("display", "inline");
                    $("#sendinfo2").css("display", "none");
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã‚“");
                })
                .catch((error) => {
                    $("#tweet_area").css("display", "none");
                    $("#sendinfo2").css("display", "inline");
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“");
                });
        }

        /*ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®å–å¾—*/
        function special() {
            const auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, see docs for a list of available properties
                    // https://firebase.google.com/docs/reference/js/firebase.User
                    const uid = user.uid;
                    // ...
                    console.log(uid);
                    const email = user.email;
                    console.log(email);

                    /*ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†*/
                    const q = query(collection(db, "uerss"));

                    onSnapshot(q, (querySnapshot) => {

                        /*ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ä¿å­˜ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ãŸã„å ´åˆã¯å¿…ãš{}å†…ã«å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹*/
                        /*querySnapshotã«å…¨éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹*/
                        console.log(querySnapshot.docs);

                        /*ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯ä½¿ã„ã«ãã„ã®ã§ã€ã»ã—ã„ã‚‚ã®ã ã‘ã‚’å–ã‚Šå‡ºã—ã¦documentsã«å…¥ã‚Œã‚‹*/

                        /*ğŸ”½ â†“ä»¥ä¸‹ã®å‡¦ç†ã¯æ¯å›ã€åŒã˜ã§ã‚¤ã‚±ã‚‹ã®ã§ä½¿ã„ã¾ã‚ã—ã¦OKDğŸ”½ */
                        const documentinfo = [];

                        querySnapshot.docs.forEach(function (doc) {
                            const data = {
                                id: doc.id,
                                data: doc.data(),
                            };
                            documentinfo.push(data);
                        });

                        console.log(documentinfo);

                        const uid = user.uid;
                        console.log(uid);
                        documentinfo.forEach(function (document) {

                            if (document.id === uid) {
                                console.log(document.data.displayname);
                                tweetname.innerHTML = `${document.data.displayname}`;
                                tweetsecret.innerHTML = `ã€${document.data.displaword}ã€`;

                            };
                        });

                    });

                } else {
                    // User is signed out
                    // ...
                }
            });
        }



        register.addEventListener("click", (e) => {
            loginsend();
        });

        fastlogin.addEventListener("click", (e) => {
            special();
        });


        loginbutton.addEventListener("click", (e) => {

            login();
            special();

        });


        //*ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œæˆ*//
        //*ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œæˆ*//
        //*ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œæˆ*//
        function send() {
            const postcreate = {
                comuname: $("#comuname").val(),
                question: $("#question").val(),
                answer: $("#answer").val(),
                time: serverTimestamp(),
            };
            addDoc(collection(db, "thread"), postcreate);
            console.log(postcreate);
        };



        $("#send").on("click", function () {
            send();
        });

        /*ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†*/
        const q = query(collection(db, "thread"), orderBy("time", "desc"));

        onSnapshot(q, (querySnapshot) => {

            /*ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ä¿å­˜ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ãŸã„å ´åˆã¯å¿…ãš{}å†…ã«å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹*/
            /*querySnapshotã«å…¨éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹*/
            console.log(querySnapshot.docs);

            /*ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯ä½¿ã„ã«ãã„ã®ã§ã€ã»ã—ã„ã‚‚ã®ã ã‘ã‚’å–ã‚Šå‡ºã—ã¦documentsã«å…¥ã‚Œã‚‹*/

            /*ğŸ”½ â†“ä»¥ä¸‹ã®å‡¦ç†ã¯æ¯å›ã€åŒã˜ã§ã‚¤ã‚±ã‚‹ã®ã§ä½¿ã„ã¾ã‚ã—ã¦OKDğŸ”½ */
            const documents = [];

            querySnapshot.docs.forEach(function (doc) {
                const data = {
                    id: doc.id,
                    data: doc.data(),
                };
                documents.push(data);
            });

            console.log(documents);


            let comunityname = document.getElementById("comunityname");
            let scretquestion = document.getElementById("scretquestion");
            let scretansewr = document.getElementById("scretansewr");
            let comunityname2 = document.getElementById("comunityname2");

            documents.forEach(function (document) {

                if (document.id === "aaIlB97HvGtzDsgoItVf") {
                    console.log(document.data.comuname);
                    comunityname.innerHTML = `${document.data.comuname}ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼`;
                    comunityname2.innerHTML = `${document.data.comuname}ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼`;
                    scretquestion.innerHTML = `ç§˜å¯†ã®è³ªå•ï¼šã€${document.data.question}ã€`;
                    scretansewr.innerHTML = `ã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã®åˆè¨€è‘‰ï¼šã€${document.data.answer}ã€`;
                };


            });



        });

        /*ãƒ„ã‚¤ãƒ¼ãƒˆé€ä¿¡*/
        function tweetsend() {
            const auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, see docs for a list of available properties
                    // https://firebase.google.com/docs/reference/js/firebase.User
                    const uid = user.uid;
                    // ...
                    console.log(uid);
                    const email = user.email;
                    console.log(email);

                    /*ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†*/
                    const q = query(collection(db, "uerss"));

                    onSnapshot(q, (querySnapshot) => {

                        /*ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ä¿å­˜ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ãŸã„å ´åˆã¯å¿…ãš{}å†…ã«å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹*/
                        /*querySnapshotã«å…¨éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹*/
                        console.log(querySnapshot.docs);

                        /*ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯ä½¿ã„ã«ãã„ã®ã§ã€ã»ã—ã„ã‚‚ã®ã ã‘ã‚’å–ã‚Šå‡ºã—ã¦documentsã«å…¥ã‚Œã‚‹*/

                        /*ğŸ”½ â†“ä»¥ä¸‹ã®å‡¦ç†ã¯æ¯å›ã€åŒã˜ã§ã‚¤ã‚±ã‚‹ã®ã§ä½¿ã„ã¾ã‚ã—ã¦OKDğŸ”½ */
                        const documentinfo = [];

                        querySnapshot.docs.forEach(function (doc) {
                            const data = {
                                id: doc.id,
                                data: doc.data(),
                            };
                            documentinfo.push(data);
                        });

                        console.log(documentinfo);

                        const uid = user.uid;
                        console.log(uid);
                        documentinfo.forEach(function (document) {

                            if (document.id === uid) {
                                console.log(document.data.displayname);
                                console.log(document.data.displaword);

                                const tweetData = {
                                    tweetname: document.data.displayname,
                                    tweetsecret: document.data.displaword,
                                    tweettext: $("#tweettext").val(),
                                    time: serverTimestamp(),
                                };
                                addDoc(collection(db, "chaat"), tweetData);
                                console.log(tweetData);
                                $("#tweettext").val("");

                            };
                        });

                    });
                } else {
                    // User is signed out
                    // ...
                }
            });

        };

        /*ãƒã‚¹ãƒˆã®å®Ÿè¡Œ*/
        $("#tweet").on("click", function () {
            tweetsend();
        });

        /*ãƒã‚¹ãƒˆã®å–å¾—*/

        const qt = query(collection(db, "chaat"), orderBy("time", "desc"));

        onSnapshot(qt, (querySnapshot) => {

            console.log(querySnapshot.docs);

            const documenttweet = [];

            querySnapshot.docs.forEach(function (doc) {
                const data = {
                    id: doc.id,
                    data: doc.data(),
                };
                documenttweet.push(data);
            });

            console.log(documenttweet);

            const htmlElements = [];
            documenttweet.forEach(function (documenttweets) {
                htmlElements.push(
                    `<li id= "${documenttweets.id}" class=output>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼š${documenttweets.data.tweetname}</p>
            <p>åˆè¨€è‘‰ï¼š${documenttweets.data.tweetsecret}</p>
            <p>ã¤ã¶ã‚„ãï¼š<br>${documenttweets.data.tweettext}<br><span class=fontsmall>(${convertTimestampToDatetime(documenttweets.data.time?.seconds)})</span></p>
          </li>`
                );
            });

            $("#output").html(htmlElements);

        });



    </script>



</body>

</html>